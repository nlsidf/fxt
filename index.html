<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯­éŸ³åˆæˆç³»ç»Ÿ - TTS + éŸ³è‰²å…‹éš†ï¼ˆæµå¼è¾“å‡ºï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .step-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .step-card.active {
            border-color: #667eea;
        }

        .step-card.completed {
            border-color: #28a745;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-number.completed {
            background: var(--success-gradient);
        }

        .step-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-box:hover, .upload-box.dragover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .audio-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .audio-preview audio {
            width: 100%;
            border-radius: 8px;
        }

        .control-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .param-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
            min-width: 40px;
            display: inline-block;
            text-align: center;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-badge .badge-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .action-button {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-generate {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-clone {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-clone:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(247, 151, 30, 0.4);
        }

        .btn-download {
            background: var(--success-gradient);
            color: white;
        }

        .btn-download:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .progress-bar-container {
            height: 30px;
            border-radius: 15px;
            background: #e9ecef;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .streaming-info {
            background: #e8f4f8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #4facfe;
        }

        .streaming-info h6 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .segment-item {
            background: white;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
        }

        .segment-item.processed {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .segment-item.processing {
            border-left-color: #ffc107;
            background: #fff8e1;
        }

        .segment-item.pending {
            border-left-color: #dee2e6;
            background: #f8f9fa;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #28a745;
        }

        .result-header {
            color: #28a745;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workflow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }

        .workflow-step {
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .workflow-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #667eea;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 3px solid #f0f0f0;
        }

        .workflow-step.active .workflow-icon {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .workflow-step.completed .workflow-icon {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .workflow-arrow {
            flex: 1;
            text-align: center;
            color: #667eea;
            font-size: 1.5em;
            position: relative;
            z-index: 1;
        }

        .workflow-line {
            position: absolute;
            top: 35px;
            left: 85px;
            right: 85px;
            height: 4px;
            background: #f0f0f0;
            z-index: 1;
        }

        .service-badge {
            background: #e9ecef;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.85em;
            color: #666;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .service-online {
            background: #d4edda;
            color: #155724;
        }

        .service-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 15px 0;
        }

        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            font-weight: 500;
            padding: 12px 25px;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .tab-pane {
            padding: 25px;
            background: white;
            border-radius: 0 0 15px 15px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .example-btn {
            font-size: 0.85rem;
            padding: 5px 10px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .streaming-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        .toggle-advanced {
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .advanced-options {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»æ ‡é¢˜ -->
        <div class="main-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold mb-3">ğŸ¤ æ™ºèƒ½è¯­éŸ³åˆæˆç³»ç»Ÿï¼ˆæµå¼è¾“å‡ºï¼‰</h1>
                    <p class="lead mb-0">æ–‡æœ¬è½¬è¯­éŸ³ + éŸ³è‰²å…‹éš†ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ - æ”¯æŒé•¿éŸ³é¢‘æµå¼å¤„ç†</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="service-badge service-online mb-2" id="tts-service-status">
                        <i class="bi bi-check-circle-fill"></i>
                        TTSæœåŠ¡åœ¨çº¿
                    </div>
                    <div class="service-badge service-online" id="isv-service-status">
                        <i class="bi bi-check-circle-fill"></i>
                        éŸ³è‰²å…‹éš†æœåŠ¡åœ¨çº¿
                    </div>
                </div>
            </div>
        </div>

        <!-- å·¥ä½œæµç¨‹å›¾ç¤º -->
        <div class="workflow-diagram">
            <div class="workflow-line"></div>
            <div class="workflow-step active" id="step1-wf">
                <div class="workflow-icon">
                    <i class="bi bi-chat-square-text"></i>
                </div>
                <h6 class="mb-0">è¾“å…¥æ–‡æœ¬</h6>
            </div>
            <div class="workflow-arrow">
                <i class="bi bi-arrow-right"></i>
            </div>
            <div class="workflow-step" id="step2-wf">
                <div class="workflow-icon">
                    <i class="bi bi-volume-up"></i>
                </div>
                <h6 class="mb-0">TTSåˆæˆ</h6>
            </div>
            <div class="workflow-arrow">
                <i class="bi bi-arrow-right"></i>
            </div>
            <div class="workflow-step" id="step3-wf">
                <div class="workflow-icon">
                    <i class="bi bi-mic"></i>
                </div>
                <h6 class="mb-0">ç›®æ ‡éŸ³è‰²</h6>
            </div>
            <div class="workflow-arrow">
                <i class="bi bi-arrow-right"></i>
            </div>
            <div class="workflow-step" id="step4-wf">
                <div class="workflow-icon">
                    <i class="bi bi-magic"></i>
                </div>
                <h6 class="mb-0">éŸ³è‰²å…‹éš†</h6>
            </div>
            <div class="workflow-arrow">
                <i class="bi bi-arrow-right"></i>
            </div>
            <div class="workflow-step" id="step5-wf">
                <div class="workflow-icon">
                    <i class="bi bi-file-earmark-music"></i>
                </div>
                <h6 class="mb-0">ä¸‹è½½ç»“æœ</h6>
            </div>
        </div>

        <!-- æ­¥éª¤å¡ç‰‡ -->
        <div class="row">
            <div class="col-lg-8">
                <!-- æ­¥éª¤1: TTSç”Ÿæˆ -->
                <div class="step-card active" id="step1-card">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3 class="step-title">TTSæ–‡æœ¬è½¬è¯­éŸ³</h3>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬</label>
                        <textarea class="form-control" id="tts-text" rows="4" placeholder="è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬..."></textarea>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary example-btn" data-text="æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è¯­éŸ³åˆæˆç³»ç»Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªé›†æˆäº†TTSå’ŒéŸ³è‰²å…‹éš†åŠŸèƒ½çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚">
                                ç¤ºä¾‹1
                            </button>
                            <button class="btn btn-sm btn-outline-primary example-btn" data-text="Hello, this is an English example text for testing the TTS system with voice cloning capabilities.">
                                ç¤ºä¾‹2
                            </button>
                            <button class="btn btn-sm btn-outline-primary example-btn" data-text="äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨æ”¹å˜ä¸–ç•Œï¼Œè¯­éŸ³åˆæˆå’ŒéŸ³è‰²å…‹éš†æŠ€æœ¯è®©æˆ‘ä»¬èƒ½å¤Ÿåˆ›é€ æ›´åŠ è‡ªç„¶å’Œä¸ªæ€§åŒ–çš„è¯­éŸ³ä½“éªŒã€‚è¿™é¡¹æŠ€æœ¯å¯ä»¥åº”ç”¨äºæœ‰å£°è¯»ç‰©ã€è™šæ‹ŸåŠ©æ‰‹ã€è§†é¢‘é…éŸ³ç­‰å¤šä¸ªé¢†åŸŸï¼Œä¸ºç”¨æˆ·æä¾›æ›´åŠ ä¸°å¯Œçš„å¬è§‰ä½“éªŒã€‚">
                                é•¿æ–‡æœ¬ç¤ºä¾‹
                            </button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">é€‰æ‹©è¯­éŸ³æ¨¡å‹</label>
                            <select class="form-select" id="tts-model">
                                <option value="zh_CN-huayan-medium">ä¸­æ–‡-èŠ±æ · (zh_CN-huayan-medium)</option>
                                <option value="en_US-lessac-low">è‹±è¯­-Lessac (en_US-lessac-low)</option>
                                <option value="en_US-lessac-medium">è‹±è¯­-Lessac Medium</option>
                                <option value="en_US-lessac-high">è‹±è¯­-Lessac High</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">è¯­é€Ÿ <span class="param-value" id="tts-speed-value">1.0</span></label>
                            <input type="range" class="control-slider" id="tts-speed" min="0.5" max="2.0" step="0.1" value="1.0">
                            <div class="d-flex justify-content-between mt-2">
                                <small>æ…¢</small>
                                <small>å¿«</small>
                            </div>
                        </div>
                    </div>

                    <div class="streaming-options">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enable-long-text" checked>
                            <label class="form-check-label" for="enable-long-text">
                                <strong>è‡ªåŠ¨å¤„ç†é•¿æ–‡æœ¬</strong> (è‡ªåŠ¨åˆ†å‰²é•¿éŸ³é¢‘è¿›è¡Œæµå¼å¤„ç†)
                            </label>
                        </div>
                        <div class="advanced-options" id="advanced-options" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ç‰‡æ®µæ—¶é•¿(ç§’)</label>
                                    <input type="number" class="form-control" id="segment-duration" min="5" max="30" value="10">
                                    <small class="text-muted">æ¯ä¸ªéŸ³é¢‘ç‰‡æ®µçš„æ—¶é•¿</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">å¹¶å‘å¤„ç†æ•°</label>
                                    <select class="form-select" id="concurrent-count">
                                        <option value="1">1 (é¡ºåºå¤„ç†)</option>
                                        <option value="2">2</option>
                                        <option value="3" selected>3</option>
                                        <option value="5">5</option>
                                    </select>
                                    <small class="text-muted">åŒæ—¶å¤„ç†çš„ç‰‡æ®µæ•°é‡</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-end mt-2">
                            <span class="toggle-advanced" id="toggle-advanced">
                                <i class="bi bi-gear"></i> é«˜çº§é€‰é¡¹
                            </span>
                        </div>
                    </div>

                    <div class="d-grid mt-3">
                        <button class="action-button btn-generate" id="generate-tts">
                            <i class="bi bi-play-circle"></i> ç”ŸæˆTTSè¯­éŸ³
                        </button>
                    </div>

                    <div id="tts-result" class="mt-3" style="display: none;">
                        <div class="audio-preview">
                            <h6 class="mb-2">TTSç”Ÿæˆç»“æœ:</h6>
                            <audio id="tts-audio-player" controls></audio>
                            <div class="mt-2 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" id="use-as-source">
                                    <i class="bi bi-arrow-right-circle"></i> ä½¿ç”¨æ­¤éŸ³é¢‘ä½œä¸ºå…‹éš†æº
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="download-tts">
                                    <i class="bi bi-download"></i> ä¸‹è½½TTSéŸ³é¢‘
                                </button>
                            </div>
                            <div id="audio-info" class="mt-2" style="display: none;">
                                <div class="alert alert-info py-2">
                                    <i class="bi bi-info-circle"></i>
                                    <span id="audio-duration-info"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤2: ç›®æ ‡éŸ³è‰² -->
                <div class="step-card" id="step2-card">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3 class="step-title">ä¸Šä¼ ç›®æ ‡éŸ³è‰²</h3>
                    </div>

                    <p class="text-muted mb-3">ä¸Šä¼ æ‚¨æƒ³è¦æ¨¡ä»¿çš„å£°éŸ³ï¼ˆå»ºè®®2-10ç§’æ¸…æ™°éŸ³é¢‘ï¼Œæ”¯æŒWAVã€MP3ã€FLACã€OGGæ ¼å¼ï¼‰</p>

                    <div class="upload-box" id="target-drop-zone">
                        <div class="upload-icon">
                            <i class="bi bi-upload"></i>
                        </div>
                        <h5>ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶</h5>
                        <p class="text-muted mb-0">å°†éŸ³é¢‘æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <input type="file" id="target-audio-file" accept="audio/*" style="display: none;">
                    </div>

                    <div id="target-audio-info" style="display: none;">
                        <div class="audio-preview">
                            <h6 class="mb-2">ç›®æ ‡éŸ³è‰²é¢„è§ˆ:</h6>
                            <audio id="target-audio-player" controls></audio>
                            <div class="file-info">
                                <p class="mb-1"><strong>æ–‡ä»¶:</strong> <span id="target-file-name"></span></p>
                                <p class="mb-0"><strong>å¤§å°:</strong> <span id="target-file-size"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <p class="text-muted"><small><i class="bi bi-info-circle"></i> æç¤ºï¼šç›®æ ‡éŸ³è‰²åº”è¯¥æ¸…æ™°æ— èƒŒæ™¯å™ªéŸ³ï¼ŒåŒ…å«å®Œæ•´çš„è¯­éŸ³ç‰¹å¾</small></p>
                    </div>
                </div>

                <!-- æ­¥éª¤3: éŸ³è‰²å…‹éš† -->
                <div class="step-card" id="step3-card">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h3 class="step-title">éŸ³è‰²å…‹éš†è®¾ç½®</h3>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">éŸ³è‰²æ··åˆå¼ºåº¦ (Tau) <span class="param-value" id="tau-value">0.3</span></label>
                        <input type="range" class="control-slider" id="tau-slider" min="0" max="1" step="0.1" value="0.3">
                        <div class="d-flex justify-content-between mt-2">
                            <small>æºéŸ³è‰²ä¸ºä¸»</small>
                            <small>ç›®æ ‡éŸ³è‰²ä¸ºä¸»</small>
                        </div>
                        <div class="alert alert-info mt-3">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>å‚æ•°å»ºè®®:</strong><br>
                                â€¢ <strong>0.0-0.2:</strong> ä¿æŒè¾ƒå¤šæºéŸ³é¢‘ç‰¹å¾<br>
                                â€¢ <strong>0.3-0.5:</strong> å¹³è¡¡æ¨¡å¼ï¼ˆæ¨èï¼‰<br>
                                â€¢ <strong>0.6-1.0:</strong> å¼ºçƒˆåº”ç”¨ç›®æ ‡éŸ³è‰²
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">æºéŸ³é¢‘çŠ¶æ€</label>
                                <div class="status-badge" id="source-status">
                                    <i class="badge-icon bi bi-hourglass"></i>
                                    ç­‰å¾…TTSç”Ÿæˆæˆ–ä¸Šä¼ 
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ç›®æ ‡éŸ³è‰²çŠ¶æ€</label>
                                <div class="status-badge" id="target-status">
                                    <i class="badge-icon bi bi-hourglass"></i>
                                    ç­‰å¾…ä¸Šä¼ 
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button class="action-button btn-clone" id="clone-btn" disabled>
                            <i class="bi bi-magic"></i> å¼€å§‹éŸ³è‰²å…‹éš†
                        </button>
                    </div>

                    <div class="progress-container" id="progress-container" style="display: none;">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div class="text-center mt-2" id="progress-info">
                            å‡†å¤‡å¤„ç†...
                        </div>
                    </div>

                    <!-- æµå¼å¤„ç†ä¿¡æ¯ -->
                    <div class="streaming-info" id="streaming-info" style="display: none;">
                        <h6><i class="bi bi-list-ul"></i> æµå¼å¤„ç†è¿›åº¦</h6>
                        <div class="segment-list" id="segment-list">
                            <!-- ç‰‡æ®µåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- çŠ¶æ€é¢æ¿ -->
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0"><i class="bi bi-speedometer2"></i> ç³»ç»ŸçŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <div id="status-container">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> å‡†å¤‡å¼€å§‹è¯­éŸ³åˆæˆ...
                            </div>
                        </div>

                        <!-- å®æ—¶ç»Ÿè®¡ -->
                        <div class="mt-3" id="real-time-stats" style="display: none;">
                            <h6><i class="bi bi-graph-up"></i> å®æ—¶ç»Ÿè®¡</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-clock text-primary"></i> å·²ç”¨æ—¶é—´: <span id="elapsed-time">0ç§’</span></li>
                                <li><i class="bi bi-cpu text-primary"></i> å¤„ç†é€Ÿåº¦: <span id="processing-speed">0ç‰‡æ®µ/ç§’</span></li>
                                <li><i class="bi bi-database text-primary"></i> æ•°æ®é‡: <span id="data-processed">0 MB</span></li>
                            </ul>
                        </div>

                        <!-- ç»“æœ -->
                        <div id="result-container" style="display: none;">
                            <div class="result-card">
                                <div class="result-header">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <h5 class="mb-0">å¤„ç†å®Œæˆ!</h5>
                                </div>
                                <div class="audio-preview">
                                    <h6 class="mb-2">æœ€ç»ˆç»“æœ:</h6>
                                    <audio id="final-result-audio" controls></audio>
                                </div>
                                <div class="mt-3">
                                    <button class="action-button btn-download w-100" id="final-download-btn">
                                        <i class="bi bi-download"></i> ä¸‹è½½æœ€ç»ˆéŸ³é¢‘ (WAVæ ¼å¼)
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <h6><i class="bi bi-graph-up"></i> å¤„ç†ç»Ÿè®¡:</h6>
                                    <ul class="list-unstyled" id="stats-list">
                                        <li><i class="bi bi-clock text-primary"></i> TTSç”Ÿæˆ: <span class="text-success" id="tts-time">-</span></li>
                                        <li><i class="bi bi-clock text-primary"></i> éŸ³è‰²å…‹éš†: <span class="text-success" id="clone-time">-</span></li>
                                        <li><i class="bi bi-pie-chart text-primary"></i> ç‰‡æ®µæ•°: <span class="text-success" id="segment-count">-</span></li>
                                        <li><i class="bi bi-clock text-primary"></i> æ€»è€—æ—¶: <span class="text-success" id="total-time">-</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- å†å²è®°å½• -->
                        <div class="mt-4">
                            <h6><i class="bi bi-clock-history"></i> æœ€è¿‘æ“ä½œ</h6>
                            <div class="list-group list-group-flush" id="history-list">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</span>
                                    <small class="text-muted">åˆšåˆš</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APIæ–‡æ¡£é€‰é¡¹å¡ -->
        <div class="mt-4">
            <ul class="nav nav-tabs" id="apiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="api-tts-tab" data-bs-toggle="tab" data-bs-target="#api-tts" type="button">
                        <i class="bi bi-volume-up"></i> TTS API
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-clone-tab" data-bs-toggle="tab" data-bs-target="#api-clone" type="button">
                        <i class="bi bi-mic"></i> éŸ³è‰²å…‹éš† API
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-streaming-tab" data-bs-toggle="tab" data-bs-target="#api-streaming" type="button">
                        <i class="bi bi-lightning"></i> æµå¼å¤„ç† API
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="apiTabsContent">
                <div class="tab-pane fade show active" id="api-tts">
                    <h5><i class="bi bi-volume-up"></i> TTS API æ¥å£</h5>
                    <p><strong>æœåŠ¡åœ°å€:</strong> <code>https://lglfr-tts.hf.space</code></p>
                    
                    <h6 class="mt-4">ç”Ÿæˆè¯­éŸ³ (POST /api/tts)</h6>
                    <div class="code-block">
{
  "text": "è¦è½¬æ¢çš„æ–‡æœ¬",
  "model": "zh_CN-huayan-medium",
  "speed": 1.0,
  "volume": 1.0,
  "noise_scale": 0.667,
  "sentence_silence": 0.5
}
                    </div>
                </div>
                
                <div class="tab-pane fade" id="api-clone">
                    <h5><i class="bi bi-mic"></i> éŸ³è‰²å…‹éš† API æ¥å£</h5>
                    <p><strong>æœåŠ¡åœ°å€:</strong> <code>https://lglfr-ivc.hf.space</code></p>
                    
                    <h6 class="mt-4">éŸ³è‰²å…‹éš† (POST /api/clone)</h6>
                    <div class="code-block">
{
  "target_audio": "data:audio/wav;base64,UklGRi...",
  "source_audio": "data:audio/wav;base64,UklGRi...",
  "tau": 0.3
}
                    </div>
                    
                    <h6 class="mt-4">å“åº”ç¤ºä¾‹:</h6>
                    <div class="code-block">
{
  "success": true,
  "message": "éŸ³è‰²å…‹éš†æˆåŠŸ",
  "result_audio": "UklGRi...",
  "stats": {
    "extract_time": "1.23s",
    "clone_time": "2.45s",
    "total_time": "3.68s"
  }
}
                    </div>
                </div>
                
                <div class="tab-pane fade" id="api-streaming">
                    <h5><i class="bi bi-lightning"></i> æµå¼å¤„ç† API ä½¿ç”¨</h5>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> æµå¼å¤„ç†é€šè¿‡å®¢æˆ·ç«¯å°†é•¿éŸ³é¢‘åˆ‡åˆ†ä¸ºå¤šä¸ªç‰‡æ®µï¼Œç„¶åå¹¶å‘å¤„ç†ï¼Œæœ€ååˆå¹¶ç»“æœã€‚
                    </div>
                    
                    <h6 class="mt-4">JavaScript æµå¼å¤„ç†ç¤ºä¾‹</h6>
                    <div class="code-block">
// åˆ‡åˆ†éŸ³é¢‘ä¸ºç‰‡æ®µ
async function splitAudioIntoSegments(audioBlob, segmentDuration = 10) {
  const audioContext = new AudioContext();
  const arrayBuffer = await audioBlob.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  
  // è®¡ç®—ç‰‡æ®µæ•°é‡
  const samplesPerSegment = segmentDuration * audioBuffer.sampleRate;
  const segments = [];
  
  for (let i = 0; i < audioBuffer.length; i += samplesPerSegment) {
    // åˆ›å»ºéŸ³é¢‘ç‰‡æ®µ...
    segments.push(audioSegment);
  }
  
  return segments;
}

// å¹¶å‘å¤„ç†ç‰‡æ®µ
async function processSegmentsConcurrently(segments, targetAudioBase64) {
  const results = [];
  const concurrentLimit = 3; // å¹¶å‘æ•°
  
  for (let i = 0; i < segments.length; i += concurrentLimit) {
    const batch = segments.slice(i, i + concurrentLimit);
    const promises = batch.map(segment => 
      fetch(`${ISV_SERVER}/api/clone`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          target_audio: targetAudioBase64,
          source_audio: segment,
          tau: 0.3
        })
      }).then(res => res.json())
    );
    
    const batchResults = await Promise.all(promises);
    results.push(...batchResults);
    
    // æ›´æ–°è¿›åº¦
    updateProgress(i + batch.length, segments.length);
  }
  
  return results;
}
                    </div>
                    
                    <h6 class="mt-4">æµå¼å¤„ç†ä¼˜åŠ¿</h6>
                    <ul>
                        <li><strong>å¤„ç†é•¿éŸ³é¢‘</strong>ï¼šæ”¯æŒå¤„ç†ä»»æ„é•¿åº¦çš„éŸ³é¢‘</li>
                        <li><strong>å®¹é”™æ€§</strong>ï¼šå•ä¸ªç‰‡æ®µå¤±è´¥ä¸å½±å“å…¶ä»–ç‰‡æ®µ</li>
                        <li><strong>å®æ—¶åé¦ˆ</strong>ï¼šå¯ä»¥å®æ—¶çœ‹åˆ°å¤„ç†è¿›åº¦</li>
                        <li><strong>å¹¶å‘åŠ é€Ÿ</strong>ï¼šå¤šä¸ªç‰‡æ®µå¯ä»¥åŒæ—¶å¤„ç†</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <footer class="mt-4 text-center text-muted">
            <p class="mb-1">æ™ºèƒ½è¯­éŸ³åˆæˆç³»ç»Ÿ &copy; 2024 | é›†æˆ Piper TTS + OpenVoice éŸ³è‰²å…‹éš† | æ”¯æŒæµå¼è¾“å‡º</p>
            <small>æŠ€æœ¯æ”¯æŒ: TTSæœåŠ¡ (https://lglfr-tts.hf.space) | éŸ³è‰²å…‹éš†æœåŠ¡ (https://lglfr-ivc.hf.space)</small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æœåŠ¡åœ°å€
        const TTS_SERVER = 'https://lglfr-tts.hf.space';
        const ISV_SERVER = 'https://lglfr-ivc.hf.space';

        // çŠ¶æ€å˜é‡
        let ttsAudioBlob = null;
        let targetAudioBlob = null;
        let clonedAudioBase64 = null;
        let ttsGenerationTime = 0;
        let cloneGenerationTime = 0;
        let audioContext = null;
        let processingStartTime = null;
        let processedSegments = 0;
        let totalSegments = 0;
        let segmentResults = [];

        // DOMå…ƒç´ 
        const elements = {
            // æœåŠ¡çŠ¶æ€
            ttsServiceStatus: document.getElementById('tts-service-status'),
            isvServiceStatus: document.getElementById('isv-service-status'),
            
            // å·¥ä½œæµå›¾ç¤º
            step1Wf: document.getElementById('step1-wf'),
            step2Wf: document.getElementById('step2-wf'),
            step3Wf: document.getElementById('step3-wf'),
            step4Wf: document.getElementById('step4-wf'),
            step5Wf: document.getElementById('step5-wf'),
            
            // TTSå…ƒç´ 
            ttsText: document.getElementById('tts-text'),
            ttsModel: document.getElementById('tts-model'),
            ttsSpeed: document.getElementById('tts-speed'),
            ttsSpeedValue: document.getElementById('tts-speed-value'),
            generateTtsBtn: document.getElementById('generate-tts'),
            ttsResult: document.getElementById('tts-result'),
            ttsAudioPlayer: document.getElementById('tts-audio-player'),
            useAsSourceBtn: document.getElementById('use-as-source'),
            downloadTtsBtn: document.getElementById('download-tts'),
            audioInfo: document.getElementById('audio-info'),
            audioDurationInfo: document.getElementById('audio-duration-info'),
            
            // æµå¼è®¾ç½®
            enableLongText: document.getElementById('enable-long-text'),
            segmentDuration: document.getElementById('segment-duration'),
            concurrentCount: document.getElementById('concurrent-count'),
            toggleAdvanced: document.getElementById('toggle-advanced'),
            advancedOptions: document.getElementById('advanced-options'),
            
            // ç›®æ ‡éŸ³è‰²å…ƒç´ 
            targetDropZone: document.getElementById('target-drop-zone'),
            targetAudioFile: document.getElementById('target-audio-file'),
            targetAudioInfo: document.getElementById('target-audio-info'),
            targetAudioPlayer: document.getElementById('target-audio-player'),
            targetFileName: document.getElementById('target-file-name'),
            targetFileSize: document.getElementById('target-file-size'),
            
            // å…‹éš†å…ƒç´ 
            tauSlider: document.getElementById('tau-slider'),
            tauValue: document.getElementById('tau-value'),
            sourceStatus: document.getElementById('source-status'),
            targetStatus: document.getElementById('target-status'),
            cloneBtn: document.getElementById('clone-btn'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressInfo: document.getElementById('progress-info'),
            streamingInfo: document.getElementById('streaming-info'),
            segmentList: document.getElementById('segment-list'),
            
            // çŠ¶æ€é¢æ¿
            statusContainer: document.getElementById('status-container'),
            resultContainer: document.getElementById('result-container'),
            finalResultAudio: document.getElementById('final-result-audio'),
            finalDownloadBtn: document.getElementById('final-download-btn'),
            ttsTime: document.getElementById('tts-time'),
            cloneTime: document.getElementById('clone-time'),
            segmentCount: document.getElementById('segment-count'),
            totalTime: document.getElementById('total-time'),
            realTimeStats: document.getElementById('real-time-stats'),
            elapsedTime: document.getElementById('elapsed-time'),
            processingSpeed: document.getElementById('processing-speed'),
            dataProcessed: document.getElementById('data-processed'),
            historyList: document.getElementById('history-list')
        };

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // å·¥å…·å‡½æ•°ï¼šæ–‡ä»¶è½¬base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // å·¥å…·å‡½æ•°ï¼šBlobè½¬base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'warning': 'alert-warning',
                'error': 'alert-danger',
                'loading': 'alert-warning'
            }[type] || 'alert-info';

            const icon = {
                'info': 'bi-info-circle',
                'success': 'bi-check-circle',
                'warning': 'bi-exclamation-triangle',
                'error': 'bi-x-circle',
                'loading': 'bi-hourglass-split'
            }[type] || 'bi-info-circle';

            elements.statusContainer.innerHTML = `
                <div class="alert ${alertClass} d-flex align-items-center">
                    <i class="bi ${icon} me-2 fs-5"></i>
                    <div>${message}</div>
                </div>
            `;
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(message);
        }

        // å·¥å…·å‡½æ•°ï¼šæ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            const historyItem = document.createElement('div');
            historyItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            historyItem.innerHTML = `
                <span>${message}</span>
                <small class="text-muted">${timeString}</small>
            `;
            
            elements.historyList.insertBefore(historyItem, elements.historyList.firstChild);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            const items = elements.historyList.querySelectorAll('.list-group-item');
            if (items.length > 10) {
                elements.historyList.removeChild(items[items.length - 1]);
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent, message) {
            elements.progressBar.style.width = `${percent}%`;
            elements.progressBar.textContent = `${Math.round(percent)}%`;
            elements.progressInfo.textContent = message;
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            elements.progressContainer.style.display = 'block';
        }

        // å·¥å…·å‡½æ•°ï¼šéšè—è¿›åº¦æ¡
        function hideProgress() {
            setTimeout(() => {
                elements.progressContainer.style.display = 'none';
                updateProgress(0, 'å‡†å¤‡å¤„ç†...');
            }, 1000);
        }

        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°å·¥ä½œæµæ­¥éª¤
        function updateWorkflowStep(step) {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            [elements.step1Wf, elements.step2Wf, elements.step3Wf, elements.step4Wf, elements.step5Wf].forEach(el => {
                el.classList.remove('active', 'completed');
            });
            
            // æ ¹æ®æ­¥éª¤æ›´æ–°
            switch(step) {
                case 'step1':
                    elements.step1Wf.classList.add('active');
                    break;
                case 'step2':
                    elements.step1Wf.classList.add('completed');
                    elements.step2Wf.classList.add('active');
                    break;
                case 'step3':
                    elements.step1Wf.classList.add('completed');
                    elements.step2Wf.classList.add('completed');
                    elements.step3Wf.classList.add('active');
                    break;
                case 'step4':
                    elements.step1Wf.classList.add('completed');
                    elements.step2Wf.classList.add('completed');
                    elements.step3Wf.classList.add('completed');
                    elements.step4Wf.classList.add('active');
                    break;
                case 'step5':
                    [elements.step1Wf, elements.step2Wf, elements.step3Wf, elements.step4Wf, elements.step5Wf]
                        .forEach(el => el.classList.add('completed'));
                    elements.step5Wf.classList.add('active');
                    break;
            }
        }

        // å·¥å…·å‡½æ•°ï¼šåˆå§‹åŒ–AudioContext
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // å·¥å…·å‡½æ•°ï¼šåˆ‡åˆ†éŸ³é¢‘ä¸ºç‰‡æ®µï¼ˆä»isv.htmlå¤åˆ¶å¹¶ä¿®æ”¹ï¼‰
        async function splitAudioIntoSegments(audioBlob, segmentDuration = 10) {
            const ctx = getAudioContext();
            const arrayBuffer = await audioBlob.arrayBuffer();
            const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
            
            const sampleRate = audioBuffer.sampleRate;
            const samplesPerSegment = segmentDuration * sampleRate;
            const totalSamples = audioBuffer.length;
            const numSegments = Math.ceil(totalSamples / samplesPerSegment);
            
            console.log(`éŸ³é¢‘æ€»æ—¶é•¿: ${(totalSamples / sampleRate).toFixed(2)}ç§’`);
            console.log(`å°†åˆ‡åˆ†ä¸º ${numSegments} ä¸ªç‰‡æ®µï¼Œæ¯ä¸ª ${segmentDuration} ç§’`);
            
            const segments = [];
            for (let i = 0; i < numSegments; i++) {
                const startSample = i * samplesPerSegment;
                const endSample = Math.min((i + 1) * samplesPerSegment, totalSamples);
                const segmentBuffer = ctx.createBuffer(
                    audioBuffer.numberOfChannels,
                    endSample - startSample,
                    sampleRate
                );

                for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                    const channelData = audioBuffer.getChannelData(channel);
                    const segmentData = segmentBuffer.getChannelData(channel);
                    for (let j = 0; j < segmentData.length; j++) {
                        segmentData[j] = channelData[startSample + j];
                    }
                }

                // å°†AudioBufferè½¬æ¢ä¸ºWAV Blob
                const wavBlob = await audioBufferToWav(segmentBuffer);
                const base64 = await blobToBase64(wavBlob);
                segments.push({
                    index: i,
                    base64: base64,
                    duration: (endSample - startSample) / sampleRate
                });
            }

            return {
                segments: segments,
                totalDuration: totalSamples / sampleRate,
                sampleRate: sampleRate,
                numSegments: numSegments
            };
        }

        // å·¥å…·å‡½æ•°ï¼šAudioBufferè½¬WAVï¼ˆä»isv.htmlå¤åˆ¶ï¼‰
        async function audioBufferToWav(audioBuffer) {
            const numberOfChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;

            const bytesPerSample = bitDepth / 8;
            const blockAlign = numberOfChannels * bytesPerSample;

            const dataLength = audioBuffer.length * blockAlign;
            const bufferLength = 44 + dataLength;

            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);

            // WAVæ–‡ä»¶å¤´
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // å†™å…¥éŸ³é¢‘æ•°æ®
            const channels = [];
            for (let i = 0; i < numberOfChannels; i++) {
                channels.push(audioBuffer.getChannelData(i));
            }

            let offset = 44;
            for (let i = 0; i < audioBuffer.length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    let sample = Math.max(-1, Math.min(1, channels[channel][i]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset, sample, true);
                    offset += 2;
                }
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // å·¥å…·å‡½æ•°ï¼šåˆå¹¶éŸ³é¢‘ç‰‡æ®µï¼ˆä»isv.htmlå¤åˆ¶å¹¶ä¿®æ”¹ï¼‰
        async function mergeAudioSegments(base64Segments) {
            const ctx = getAudioContext();
            const segments = [];

            // è§£ç æ‰€æœ‰ç‰‡æ®µ
            for (let base64 of base64Segments) {
                // å¤„ç†ä¸åŒçš„base64æ ¼å¼
                let audioData;
                if (base64.includes(',')) {
                    audioData = atob(base64.split(',')[1]);
                } else {
                    audioData = atob(base64);
                }

                const arrayBuffer = new ArrayBuffer(audioData.length);
                const view = new Uint8Array(arrayBuffer);
                for (let i = 0; i < audioData.length; i++) {
                    view[i] = audioData.charCodeAt(i);
                }
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                segments.push(audioBuffer);
            }

            // åˆ›å»ºåˆå¹¶åçš„buffer
            const totalLength = segments.reduce((sum, seg) => sum + seg.length, 0);
            const mergedBuffer = ctx.createBuffer(
                segments[0].numberOfChannels,
                totalLength,
                segments[0].sampleRate
            );

            // åˆå¹¶æ‰€æœ‰ç‰‡æ®µ
            let offset = 0;
            for (const segment of segments) {
                for (let channel = 0; channel < segment.numberOfChannels; channel++) {
                    const mergedData = mergedBuffer.getChannelData(channel);
                    const segmentData = segment.getChannelData(channel);
                    for (let i = 0; i < segmentData.length; i++) {
                        mergedData[offset + i] = segmentData[i];
                    }
                }
                offset += segment.length;
            }

            return audioBufferToWav(mergedBuffer);
        }

        // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºç‰‡æ®µåˆ—è¡¨æ˜¾ç¤º
        function createSegmentList(numSegments) {
            elements.segmentList.innerHTML = '';
            for (let i = 0; i < numSegments; i++) {
                const segmentItem = document.createElement('div');
                segmentItem.className = 'segment-item pending';
                segmentItem.id = `segment-${i}`;
                segmentItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>ç‰‡æ®µ ${i + 1}</strong> - ç­‰å¾…å¤„ç†</span>
                        <span class="badge bg-secondary">å¾…å¤„ç†</span>
                    </div>
                `;
                elements.segmentList.appendChild(segmentItem);
            }
            elements.streamingInfo.style.display = 'block';
        }

        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°ç‰‡æ®µçŠ¶æ€
        function updateSegmentStatus(index, status, message = '') {
            const segmentItem = document.getElementById(`segment-${index}`);
            if (segmentItem) {
                segmentItem.className = `segment-item ${status}`;
                
                let badgeText = 'å¾…å¤„ç†';
                let badgeClass = 'bg-secondary';
                
                switch(status) {
                    case 'processing':
                        badgeText = 'å¤„ç†ä¸­';
                        badgeClass = 'bg-warning';
                        break;
                    case 'processed':
                        badgeText = 'å·²å®Œæˆ';
                        badgeClass = 'bg-success';
                        break;
                    case 'error':
                        badgeText = 'å¤±è´¥';
                        badgeClass = 'bg-danger';
                        break;
                }
                
                segmentItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>ç‰‡æ®µ ${index + 1}</strong> ${message}</span>
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>
                `;
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°å®æ—¶ç»Ÿè®¡
        function updateRealTimeStats() {
            if (!processingStartTime) return;
            
            const elapsed = (Date.now() - processingStartTime) / 1000;
            elements.elapsedTime.textContent = `${elapsed.toFixed(1)}ç§’`;
            
            if (processedSegments > 0) {
                const speed = processedSegments / elapsed;
                elements.processingSpeed.textContent = `${speed.toFixed(1)}ç‰‡æ®µ/ç§’`;
                
                const dataSize = (processedSegments * 10 * 22050 * 2) / (1024 * 1024); // ä¼°ç®—æ•°æ®é‡
                elements.dataProcessed.textContent = `${dataSize.toFixed(2)} MB`;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            checkServices();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // TTSè¯­é€Ÿæ»‘å—
            elements.ttsSpeed.addEventListener('input', function() {
                elements.ttsSpeedValue.textContent = this.value;
            });

            // Tauæ»‘å—
            elements.tauSlider.addEventListener('input', function() {
                elements.tauValue.textContent = this.value;
            });

            // ç¤ºä¾‹æ–‡æœ¬æŒ‰é’®
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    elements.ttsText.value = this.getAttribute('data-text');
                    updateWorkflowStep('step1');
                    showStatus('å·²åŠ è½½ç¤ºä¾‹æ–‡æœ¬', 'info');
                });
            });

            // é«˜çº§é€‰é¡¹åˆ‡æ¢
            elements.toggleAdvanced.addEventListener('click', function() {
                const isVisible = elements.advancedOptions.style.display !== 'none';
                elements.advancedOptions.style.display = isVisible ? 'none' : 'block';
                this.innerHTML = isVisible ? 
                    '<i class="bi bi-gear"></i> é«˜çº§é€‰é¡¹' : 
                    '<i class="bi bi-gear-fill"></i> éšè—é«˜çº§é€‰é¡¹';
            });

            // TTSç”ŸæˆæŒ‰é’®
            elements.generateTtsBtn.addEventListener('click', generateTTS);
            
            // ä½¿ç”¨TTSéŸ³é¢‘ä½œä¸ºæº
            elements.useAsSourceBtn.addEventListener('click', function() {
                if (ttsAudioBlob) {
                    checkCloneReady();
                    showStatus('å·²é€‰æ‹©TTSéŸ³é¢‘ä½œä¸ºå…‹éš†æº', 'success');
                    updateWorkflowStep('step3');
                }
            });
            
            // ä¸‹è½½TTSéŸ³é¢‘
            elements.downloadTtsBtn.addEventListener('click', function() {
                if (ttsAudioBlob) {
                    const url = URL.createObjectURL(ttsAudioBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tts_output_${Date.now()}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showStatus('TTSéŸ³é¢‘å·²ä¸‹è½½', 'success');
                }
            });

            // ç›®æ ‡éŸ³è‰²ä¸Šä¼ 
            elements.targetDropZone.addEventListener('click', () => {
                elements.targetAudioFile.click();
            });

            elements.targetDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.targetDropZone.classList.add('dragover');
            });

            elements.targetDropZone.addEventListener('dragleave', () => {
                elements.targetDropZone.classList.remove('dragover');
            });

            elements.targetDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.targetDropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleTargetAudio(e.dataTransfer.files[0]);
                }
            });

            elements.targetAudioFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleTargetAudio(e.target.files[0]);
                }
            });

            // å…‹éš†æŒ‰é’®
            elements.cloneBtn.addEventListener('click', startCloning);
            
            // ä¸‹è½½æœ€ç»ˆç»“æœæŒ‰é’®
            elements.finalDownloadBtn.addEventListener('click', downloadFinalResult);
            
            // å®æ—¶ç»Ÿè®¡æ›´æ–°
            setInterval(updateRealTimeStats, 1000);
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            // æ£€æŸ¥TTSæœåŠ¡
            try {
                const response = await fetch(`${TTS_SERVER}/api/health`);
                if (response.ok) {
                    elements.ttsServiceStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> TTSæœåŠ¡åœ¨çº¿';
                    elements.ttsServiceStatus.className = 'service-badge service-online';
                }
            } catch (error) {
                elements.ttsServiceStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> TTSæœåŠ¡ç¦»çº¿';
                elements.ttsServiceStatus.className = 'service-badge service-offline';
            }

            // æ£€æŸ¥éŸ³è‰²å…‹éš†æœåŠ¡
            try {
                const response = await fetch(`${ISV_SERVER}/api/health`);
                if (response.ok) {
                    elements.isvServiceStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> éŸ³è‰²å…‹éš†æœåŠ¡åœ¨çº¿';
                    elements.isvServiceStatus.className = 'service-badge service-online';
                }
            } catch (error) {
                elements.isvServiceStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> éŸ³è‰²å…‹éš†æœåŠ¡ç¦»çº¿';
                elements.isvServiceStatus.className = 'service-badge service-offline';
            }
        }

        // å¤„ç†ç›®æ ‡éŸ³é¢‘
        async function handleTargetAudio(file) {
            if (!file.type.startsWith('audio/')) {
                showStatus('è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼ˆWAVã€MP3ã€FLACã€OGGæ ¼å¼ï¼‰', 'error');
                return;
            }

            // é™åˆ¶æ–‡ä»¶å¤§å°
            if (file.size > 50 * 1024 * 1024) { // 50MB
                showStatus('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·ä¸Šä¼ å°äº50MBçš„éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }

            targetAudioBlob = file;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            elements.targetFileName.textContent = file.name;
            elements.targetFileSize.textContent = formatFileSize(file.size);
            elements.targetAudioInfo.style.display = 'block';
            
            // åˆ›å»ºéŸ³é¢‘URLå¹¶æ’­æ”¾
            const audioUrl = URL.createObjectURL(file);
            elements.targetAudioPlayer.src = audioUrl;
            
            // æ›´æ–°çŠ¶æ€
            elements.targetStatus.innerHTML = `<i class="badge-icon bi bi-check-circle"></i> å·²ä¸Šä¼ : ${file.name}`;
            elements.targetStatus.className = 'status-badge status-success';
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œå…‹éš†
            checkCloneReady();
            
            // æ›´æ–°å·¥ä½œæµ
            updateWorkflowStep('step3');
            
            showStatus('ç›®æ ‡éŸ³è‰²å·²ä¸Šä¼ ', 'success');
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œå…‹éš†
        function checkCloneReady() {
            const sourceReady = ttsAudioBlob !== null;
            const targetReady = targetAudioBlob !== null;
            
            if (sourceReady && targetReady) {
                elements.cloneBtn.disabled = false;
                elements.cloneBtn.innerHTML = '<i class="bi bi-magic"></i> å¼€å§‹éŸ³è‰²å…‹éš†';
                updateWorkflowStep('step4');
            } else {
                elements.cloneBtn.disabled = true;
            }
        }

        // ç”ŸæˆTTS
        async function generateTTS() {
            const text = elements.ttsText.value.trim();
            if (!text) {
                showStatus('è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬', 'error');
                return;
            }

            // è®°å½•å¼€å§‹æ—¶é—´
            const startTime = Date.now();
            
            showStatus('æ­£åœ¨ç”ŸæˆTTSè¯­éŸ³...', 'loading');
            elements.generateTtsBtn.disabled = true;
            elements.generateTtsBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';

            try {
                const response = await fetch(`${TTS_SERVER}/api/tts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model: elements.ttsModel.value,
                        speed: parseFloat(elements.ttsSpeed.value),
                        volume: 1.0,
                        noise_scale: 0.667,
                        sentence_silence: 0.5
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTPé”™è¯¯: ${response.status} - ${errorText.substring(0, 100)}`);
                }

                // è·å–éŸ³é¢‘æ•°æ®
                const audioBlob = await response.blob();
                ttsAudioBlob = audioBlob;
                
                // è®¡ç®—è€—æ—¶
                ttsGenerationTime = Date.now() - startTime;
                
                // è·å–éŸ³é¢‘æ—¶é•¿
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioElement = new Audio(audioUrl);
                
                audioElement.addEventListener('loadedmetadata', () => {
                    const duration = audioElement.duration;
                    elements.audioDurationInfo.textContent = `éŸ³é¢‘æ—¶é•¿: ${duration.toFixed(2)}ç§’`;
                    elements.audioInfo.style.display = 'block';
                    
                    // æ ¹æ®æ—¶é•¿å†³å®šæ˜¯å¦å¯ç”¨æµå¼å¤„ç†å»ºè®®
                    if (duration > 30 && elements.enableLongText.checked) {
                        showStatus(`æ£€æµ‹åˆ°é•¿éŸ³é¢‘(${duration.toFixed(2)}ç§’)ï¼Œå»ºè®®ä½¿ç”¨æµå¼å¤„ç†`, 'info');
                    }
                });
                
                audioElement.load();
                
                // è®¾ç½®æ’­æ”¾å™¨
                elements.ttsAudioPlayer.src = audioUrl;
                elements.ttsResult.style.display = 'block';
                
                // æ›´æ–°çŠ¶æ€
                elements.sourceStatus.innerHTML = `<i class="badge-icon bi bi-check-circle"></i> TTSéŸ³é¢‘å°±ç»ª (${(ttsGenerationTime/1000).toFixed(2)}ç§’)`;
                elements.sourceStatus.className = 'status-badge status-success';
                
                showStatus(`TTSè¯­éŸ³ç”ŸæˆæˆåŠŸ! è€—æ—¶: ${(ttsGenerationTime/1000).toFixed(2)}ç§’`, 'success');
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œå…‹éš†
                checkCloneReady();
                
                // æ›´æ–°å·¥ä½œæµ
                updateWorkflowStep('step2');

            } catch (error) {
                console.error('TTSç”Ÿæˆå¤±è´¥:', error);
                showStatus(`TTSç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            } finally {
                elements.generateTtsBtn.disabled = false;
                elements.generateTtsBtn.innerHTML = '<i class="bi bi-play-circle"></i> ç”ŸæˆTTSè¯­éŸ³';
            }
        }

        // å¼€å§‹éŸ³è‰²å…‹éš†ï¼ˆæ”¯æŒæµå¼å¤„ç†ï¼‰
        async function startCloning() {
            if (!ttsAudioBlob || !targetAudioBlob) {
                showStatus('è¯·å…ˆå®ŒæˆTTSç”Ÿæˆå’Œç›®æ ‡éŸ³è‰²ä¸Šä¼ ', 'error');
                return;
            }

            // é‡ç½®çŠ¶æ€
            segmentResults = [];
            processedSegments = 0;
            totalSegments = 0;
            processingStartTime = Date.now();
            
            showStatus('æ­£åœ¨è¿›è¡ŒéŸ³è‰²å…‹éš†...', 'loading');
            showProgress();
            updateProgress(10, 'æ­£åœ¨å‡†å¤‡éŸ³é¢‘æ•°æ®...');
            
            elements.cloneBtn.disabled = true;
            elements.cloneBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> å…‹éš†ä¸­...';
            
            // æ˜¾ç¤ºå®æ—¶ç»Ÿè®¡
            elements.realTimeStats.style.display = 'block';

            try {
                // è½¬æ¢ç›®æ ‡éŸ³è‰²ä¸ºbase64
                updateProgress(20, 'æ­£åœ¨è½¬æ¢ç›®æ ‡éŸ³è‰²...');
                const targetBase64 = await fileToBase64(targetAudioBlob);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æµå¼å¤„ç†
                const shouldStream = elements.enableLongText.checked;
                
                if (shouldStream) {
                    // æµå¼å¤„ç†æ¨¡å¼
                    await streamingClone(targetBase64);
                } else {
                    // å•æ¬¡å¤„ç†æ¨¡å¼
                    await singleClone(targetBase64);
                }

            } catch (error) {
                console.error('éŸ³è‰²å…‹éš†å¤±è´¥:', error);
                showStatus(`éŸ³è‰²å…‹éš†å¤±è´¥: ${error.message}`, 'error');
            } finally {
                elements.cloneBtn.disabled = false;
                elements.cloneBtn.innerHTML = '<i class="bi bi-magic"></i> å¼€å§‹éŸ³è‰²å…‹éš†';
                hideProgress();
                elements.realTimeStats.style.display = 'none';
            }
        }

        // å•æ¬¡å¤„ç†ï¼ˆçŸ­éŸ³é¢‘ï¼‰
        async function singleClone(targetBase64) {
            updateProgress(40, 'æ­£åœ¨å¤„ç†æ•´ä¸ªéŸ³é¢‘...');
            
            const sourceBase64 = await blobToBase64(ttsAudioBlob);
            
            updateProgress(60, 'æ­£åœ¨å‘é€å…‹éš†è¯·æ±‚...');
            
            const response = await fetch(`${ISV_SERVER}/api/clone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target_audio: targetBase64,
                    source_audio: sourceBase64,
                    tau: parseFloat(elements.tauSlider.value)
                })
            });

            updateProgress(80, 'æ­£åœ¨å¤„ç†è¿”å›ç»“æœ...');

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTPé”™è¯¯: ${response.status} - ${errorText.substring(0, 100)}`);
            }

            const result = await response.json();
            
            updateProgress(90, 'æ­£åœ¨å‡†å¤‡æœ€ç»ˆç»“æœ...');
            
            if (result.success) {
                clonedAudioBase64 = result.result_audio;
                
                // è®¡ç®—æ€»è€—æ—¶
                cloneGenerationTime = Date.now() - processingStartTime;
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                showFinalResult(result);
                updateWorkflowStep('step5');
                
                showStatus(`éŸ³è‰²å…‹éš†å®Œæˆ! æ€»è€—æ—¶: ${(cloneGenerationTime/1000).toFixed(2)}ç§’`, 'success');
            } else {
                throw new Error(result.error || 'å…‹éš†å¤±è´¥');
            }
        }

        // æµå¼å¤„ç†ï¼ˆé•¿éŸ³é¢‘ï¼‰
        async function streamingClone(targetBase64) {
            // è·å–éŸ³é¢‘ä¿¡æ¯
            const audioUrl = URL.createObjectURL(ttsAudioBlob);
            const audioElement = new Audio(audioUrl);
            
            // ç­‰å¾…éŸ³é¢‘åŠ è½½ä»¥è·å–æ—¶é•¿
            await new Promise(resolve => {
                audioElement.addEventListener('loadedmetadata', resolve);
                audioElement.load();
            });
            
            const audioDuration = audioElement.duration;
            
            // å†³å®šæ˜¯å¦åˆ‡åˆ†
            const segmentDuration = parseInt(elements.segmentDuration.value);
            const shouldSplit = audioDuration > segmentDuration * 1.5; // å¦‚æœæ—¶é•¿è¶…è¿‡1.5ä¸ªç‰‡æ®µå°±åˆ‡åˆ†
            
            if (!shouldSplit) {
                // éŸ³é¢‘ä¸é•¿ï¼Œä½¿ç”¨å•æ¬¡å¤„ç†
                showStatus('éŸ³é¢‘è¾ƒçŸ­ï¼Œä½¿ç”¨å•æ¬¡å¤„ç†æ¨¡å¼', 'info');
                return singleClone(targetBase64);
            }
            
            showStatus(`å¼€å§‹æµå¼å¤„ç†: å°†${audioDuration.toFixed(2)}ç§’éŸ³é¢‘åˆ‡åˆ†ä¸ºç‰‡æ®µ`, 'info');
            
            // åˆ‡åˆ†éŸ³é¢‘
            updateProgress(30, 'æ­£åœ¨åˆ‡åˆ†éŸ³é¢‘...');
            const splitResult = await splitAudioIntoSegments(ttsAudioBlob, segmentDuration);
            totalSegments = splitResult.numSegments;
            
            // åˆ›å»ºç‰‡æ®µåˆ—è¡¨æ˜¾ç¤º
            createSegmentList(totalSegments);
            
            updateProgress(40, `å¼€å§‹å¤„ç† ${totalSegments} ä¸ªç‰‡æ®µ...`);
            
            // å¹¶å‘å¤„ç†ç‰‡æ®µ
            const concurrentLimit = parseInt(elements.concurrentCount.value);
            const segments = splitResult.segments;
            segmentResults = new Array(totalSegments);
            
            // åˆ†æ‰¹å¤„ç†
            for (let i = 0; i < segments.length; i += concurrentLimit) {
                const batch = segments.slice(i, i + concurrentLimit);
                
                // æ›´æ–°å½“å‰å¤„ç†ä¸­çš„ç‰‡æ®µçŠ¶æ€
                batch.forEach(segment => {
                    updateSegmentStatus(segment.index, 'processing', 'å¤„ç†ä¸­...');
                });
                
                // åˆ›å»ºæ‰¹æ¬¡å¤„ç†Promise
                const batchPromises = batch.map(async (segment) => {
                    try {
                        updateSegmentStatus(segment.index, 'processing', 'å‘é€è¯·æ±‚...');
                        
                        const response = await fetch(`${ISV_SERVER}/api/clone`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                target_audio: targetBase64,
                                source_audio: segment.base64,
                                tau: parseFloat(elements.tauSlider.value)
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`ç‰‡æ®µ ${segment.index + 1} è¯·æ±‚å¤±è´¥`);
                        }

                        const result = await response.json();
                        
                        if (result.success) {
                            segmentResults[segment.index] = result.result_audio;
                            processedSegments++;
                            updateSegmentStatus(segment.index, 'processed', `å®Œæˆ (${segment.duration.toFixed(1)}ç§’)`);
                            
                            // æ›´æ–°è¿›åº¦
                            const progressPercent = 40 + (processedSegments / totalSegments) * 50;
                            updateProgress(
                                progressPercent,
                                `å¤„ç†ç‰‡æ®µ ${processedSegments}/${totalSegments}...`
                            );
                            
                            return result;
                        } else {
                            throw new Error(result.error || 'ç‰‡æ®µå¤„ç†å¤±è´¥');
                        }
                    } catch (error) {
                        console.error(`ç‰‡æ®µ ${segment.index + 1} å¤„ç†å¤±è´¥:`, error);
                        updateSegmentStatus(segment.index, 'error', error.message);
                        throw error;
                    }
                });
                
                // ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆ
                try {
                    await Promise.all(batchPromises);
                } catch (error) {
                    // å•ä¸ªç‰‡æ®µå¤±è´¥ä¸å½±å“å…¶ä»–ç‰‡æ®µ
                    showStatus(`éƒ¨åˆ†ç‰‡æ®µå¤„ç†å¤±è´¥ï¼Œç»§ç»­å¤„ç†å…¶ä»–ç‰‡æ®µ`, 'warning');
                }
            }
            
            updateProgress(90, 'æ­£åœ¨åˆå¹¶éŸ³é¢‘ç‰‡æ®µ...');
            
            // è¿‡æ»¤å‡ºæˆåŠŸçš„ç‰‡æ®µ
            const successfulSegments = segmentResults.filter(result => result !== undefined);
            
            if (successfulSegments.length === 0) {
                throw new Error('æ‰€æœ‰ç‰‡æ®µå¤„ç†éƒ½å¤±è´¥äº†');
            }
            
            // åˆå¹¶ç‰‡æ®µ
            const mergedWavBlob = await mergeAudioSegments(successfulSegments);
            const mergedBase64 = await blobToBase64(mergedWavBlob);
            
            // æå–çº¯base64éƒ¨åˆ†
            clonedAudioBase64 = mergedBase64.split(',')[1];
            
            // è®¡ç®—æ€»è€—æ—¶
            cloneGenerationTime = Date.now() - processingStartTime;
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            showFinalResult({
                success: true,
                message: `éŸ³è‰²å…‹éš†å®Œæˆ (${successfulSegments.length}/${totalSegments}ç‰‡æ®µæˆåŠŸ)`
            });
            updateWorkflowStep('step5');
            
            showStatus(`æµå¼å¤„ç†å®Œæˆ! æˆåŠŸå¤„ç† ${successfulSegments.length}/${totalSegments} ä¸ªç‰‡æ®µï¼Œæ€»è€—æ—¶: ${(cloneGenerationTime/1000).toFixed(2)}ç§’`, 'success');
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function showFinalResult(result) {
            // åˆ›å»ºéŸ³é¢‘URL
            const audioUrl = `data:audio/wav;base64,${clonedAudioBase64}`;
            elements.finalResultAudio.src = audioUrl;
            
            // æ˜¾ç¤ºç»“æœå®¹å™¨
            elements.resultContainer.style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            elements.ttsTime.textContent = `${(ttsGenerationTime/1000).toFixed(2)}ç§’`;
            elements.cloneTime.textContent = `${(cloneGenerationTime/1000).toFixed(2)}ç§’`;
            elements.segmentCount.textContent = totalSegments > 0 ? `${totalSegments}ä¸ªç‰‡æ®µ` : 'å•æ¬¡å¤„ç†';
            elements.totalTime.textContent = `${((ttsGenerationTime + cloneGenerationTime)/1000).toFixed(2)}ç§’`;
            
            // æ»šåŠ¨åˆ°ç»“æœä½ç½®
            elements.resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // ä¸‹è½½æœ€ç»ˆç»“æœ
        function downloadFinalResult() {
            if (!clonedAudioBase64) {
                showStatus('æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘', 'error');
                return;
            }
            
            try {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = `data:audio/wav;base64,${clonedAudioBase64}`;
                link.download = `cloned_voice_${Date.now()}.wav`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatus('éŸ³é¢‘å·²ä¸‹è½½', 'success');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showStatus(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>